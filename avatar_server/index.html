<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
    <title>Avatar Control Center</title>
    <meta http-equiv="content-type" content="text/html; charset=ISO-8859-1">
    <link type="text/css" href="css/ui-darkness/jquery-ui-1.8.13.custom.css" rel="Stylesheet">
    <link rel="stylesheet" href="css/blueprint/screen.css" type="text/css" media="screen, projection">
    <link rel="stylesheet" href="css/blueprint/print.css" type="text/css" media="print">
    <link rel="stylesheet" href="css/layout-default-latest.css" type="text/css">
    <link rel="stylesheet" href="css/avatar.css" type="text/css">

</head>
<body>

<script type="text/javascript" src="js/socket.io.js"></script>
<script type="text/javascript" src="js/jquery-1.5.1.min.js"></script>
<script type="text/javascript" src="js/jquery-ui-1.8.13.custom.min.js"></script>
<script type="text/javascript" src="js/jquery.layout-latest.js"></script>
<script type="text/javascript">
    $(document).ready(function () {
        $('body').layout({
                    applyDefaultStyles: true,
                    resizable: false,
                    north__size: 100,
                    north__resizable: true,
                    south__size: 200,
                    south__resizable: true,
                    east__size: 200,
                    east__resizable: false,
                    center_minHeight: 600

                });
    });
</script>

<script type="text/javascript">
    // Globals
    var START_CHAR = "!";
    var STOP_CHAR = "?";
</script>

<script type="text/javascript">
    //Constants
    var COLLISION_WARNING = "C";
    var DEBUG_MESSAGE = "#";

    // Receiving messages
    var messageFromServer = "";
    var inMessage = false;
    var socket = new io.Socket("localhost", {port: 80});
    socket.connect();
    socket.on('connect', function() {
        console.log("Client: Client connected to server");
    });
    socket.on('message', function(data) {

        // Need to build message because it comes back in chunks
        if (data.charAt(0) == START_CHAR && data.charAt(data.length - 1) == STOP_CHAR) {
            logMessageReceivedFromServer(data.substring(1, data.length - 1));
            return;
        }

        if (data.charAt(0) == START_CHAR) {
            inMessage = true;
            messageFromServer = data.substring(1, data.length - 1);
            return;
        }

        if (data.charAt(data.length - 1) == STOP_CHAR && inMessage) {
            messageFromServer = messageFromServer.concat(data.substring(0, data.length - 1));
            logMessageReceivedFromServer(messageFromServer);
            messageFromServer = "";
            inMessage = false;
        }
    });

    socket.on('disconnect', function() {
        console.log("Client: Client disconnected from server");
    });

    function logMessageReceivedFromServer(code) {
        var message;
        var messageType = code.charAt(0);
        switch (messageType) {
            case COLLISION_WARNING:
                message = "Collision warning. Front sensor is " + code.substr(1, code.length - 1) + " cm from object.";
                break;
            default:
                message = "Unknown Message"

        }
        console.log("Client: Received message from server", message);
    }
</script>

<script type="text/javascript">
    // Sending messages
    // Command constants. Must match constants in arduino avatar.pde file
    var FORWARD = 'f';
    var REVERSE = 'b';
    var RIGHT = 'r';
    var LEFT = 'l';
    var STOP = 's';
    var EMERGENCY_STOP = 'S';

    // Parameter constants. Must match constants in arduino avatar.pde file
    var SET_RAMP_SPEED = 'A'; //A for acceleration
    var SET_MAXIMUM_SPEED = 'M';
    var SET_FORWARD_DISTANCE = 'F';
    var SET_REVERSE_DISTANCE = 'B';
    var SET_ROTATION_DISTANCE = 'R';
    var SET_COLLISION_DISTANCE = 'C';

    // System constants. Must match constants in arduino avatar.pde file
    var SET_DEBUG = 'D';
    var RESET = 'T';

    $(function() {
        $("#fwd").button();
        $("#fwd").click(function() {
            sendMessageToServer(FORWARD)
        });

        $("#rev").button();
        $("#rev").click(function() {
            sendMessageToServer(REVERSE)
        });

        $("#right").button();
        $("#right").click(function() {
            sendMessageToServer(RIGHT)
        });

        $("#left").button();
        $("#left").click(function() {
            sendMessageToServer(LEFT)
        });

        $("#stop").button();
        $("#stop").click(function() {
            sendMessageToServer(STOP)
        });

        $("#emergency_stop").button();
        $("#emergency_stop").click(function() {
            sendMessageToServer(EMERGENCY_STOP)
        });

        $("#debug").buttonset();
        $("#debug").change(function() {
            var checkedValue = $("input[@name=debug]:checked").val();
            sendMessageToServer(SET_DEBUG + checkedValue);
        });

        $("#reset").button();
        $("#reset").click(function() {
            sendMessageToServer(RESET)
        });

        // The default values for each slider should match what's in the arduino avatar.pde file
        $(function() {
            $("#rampSpeedSlider").slider({
                        range: "min",
                        min: 1,
                        max: 100,
                        value: 15,
                        slide: function(event, ui) {
                            $("#rampSpeed").val(ui.value);
                        },
                        change: function(event, ui) {
                            sendMessageToServer(SET_RAMP_SPEED + ui.value);
                        }
                    });
            $("#rampSpeed").val($("#rampSpeedSlider").slider("value"));
        });

        $(function() {
            $("#maxSpeedSlider").slider({
                        range: "min",
                        min: 1,
                        max: 100,
                        value: 36,
                        slide: function(event, ui) {
                            $("#maxSpeed").val(ui.value);
                        },
                        change: function(event, ui) {
                            sendMessageToServer(SET_MAXIMUM_SPEED + ui.value);
                        }
                    });
            $("#maxSpeed").val($("#maxSpeedSlider").slider("value"));
        });

        $(function() {
            $("#forwardDistanceSlider").slider({
                        range: "min",
                        min: 1,
                        max: 100,
                        value: 20,
                        slide: function(event, ui) {
                            $("#forwardDistance").val(ui.value);
                        },
                        change: function(event, ui) {
                            sendMessageToServer(SET_FORWARD_DISTANCE + ui.value);
                        }
                    });
            $("#forwardDistance").val($("#forwardDistanceSlider").slider("value"));
        });

        $(function() {
            $("#reverseDistanceSlider").slider({
                        range: "min",
                        min: 1,
                        max: 100,
                        value: 10,
                        slide: function(event, ui) {
                            $("#reverseDistance").val(ui.value);
                        },
                        change: function(event, ui) {
                            sendMessageToServer(SET_REVERSE_DISTANCE + ui.value);
                        }
                    });
            $("#reverseDistance").val($("#reverseDistanceSlider").slider("value"));
        });

        $(function() {
            $("#rotationDistanceSlider").slider({
                        range: "min",
                        min: 1,
                        max: 50,
                        value: 5,
                        slide: function(event, ui) {
                            $("#rotationDistance").val(ui.value);
                        },
                        change: function(event, ui) {
                            sendMessageToServer(SET_ROTATION_DISTANCE + ui.value);
                        }
                    });
            $("#rotationDistance").val($("#rotationDistanceSlider").slider("value"));
        });

        $(function() {
            $("#frontSensorSlider").slider({
                        range: "min",
                        min: 5,
                        max: 100,
                        value: 5,
                        slide: function(event, ui) {
                            $("#frontSensor").val(ui.value);
                        },
                        change: function(event, ui) {
                            sendMessageToServer(SET_COLLISION_DISTANCE + ui.value);
                        }
                    });
            $("#frontSensor").val($("#frontSensorSlider").slider("value"));
        });
    });

    function sendMessageToServer(message) {
        socket.send(START_CHAR + message + STOP_CHAR);
    }

</script>
<div class="ui-layout-center">
    <div class="container">

        <div class="span-24 prepend-2">
            <button id="fwd">FWD</button>
        </div>
        <div class="span-2">
            <button id="left">LEFT</button>
        </div>
        <div class="span-2">
            <button id="stop">STOP</button>
        </div>
        <div class="span-2 colborder">
            <button id="right">RIGHT</button>
        </div>

        <div class="span-24 prepend-2">
            <button id="rev">REV</button>
        </div>
        <div class="span-24 prepend-1">
            <button id="emergency_stop">EMERGENCY STOP</button>
        </div>


    </div>
</div>

<div class="ui-layout-east">
    <label for="rampSpeed">Ramp speed:</label>
    <input type="text" id="rampSpeed" style="border:0; color:#f6931f; font-weight:bold;"/>

    <div id="rampSpeedSlider"></div>

    <label for="maxSpeed">Max speed:</label>
    <input type="text" id="maxSpeed" style="border:0; color:#f6931f; font-weight:bold;"/>

    <div id="maxSpeedSlider"></div>

    <label for="forwardDistance">Forward distance:</label>
    <input type="text" id="forwardDistance" style="border:0; color:#f6931f; font-weight:bold;"/>

    <div id="forwardDistanceSlider"></div>

    <label for="reverseDistance">Reverse distance:</label>
    <input type="text" id="reverseDistance" style="border:0; color:#f6931f; font-weight:bold;"/>

    <div id="reverseDistanceSlider"></div>

    <label for="rotationDistance">Rotation distance:</label>
    <input type="text" id="rotationDistance" style="border:0; color:#f6931f; font-weight:bold;"/>

    <div id="rotationDistanceSlider"></div>
    <hr>
    <label for="frontSensor">Front sensor distance warning:</label>
    <input type="text" id="frontSensor" style="border:0; color:#f6931f; font-weight:bold;"/>

    <div id="frontSensorSlider"></div>
    <hr>
    <button id="reset">reset</button>
</div>

<div class="ui-layout-north">
    <textarea id="messages" class="messages"></textarea>

</div>

<div class="ui-layout-south">
     <div id="debug">
        Debug output:
		<input type="radio" id="debugOn" value="1" name="debug" /><label for="debugOn">On</label>
		<input type="radio" id="debugOff" value="0" name="debug" checked="checked" /><label for="debugOff">Off</label>
	</div>
    <textarea id="debugOutput" class="debugOutput"></textarea>

</div>

<!--<div class="ui-layout-west">-->
<!--West-->
<!--</div>-->


</body>
</html>